name: ðŸš€ Build & Deploy

on:
  workflow_run:
    workflows: ["ðŸ§ª Test & Quality Assurance"]
    types: [completed]
    branches: [ master, develop ]

env:
  NODE_VERSION: '22.x'

jobs:
  check-tests:
    name: ðŸ” Verify Tests Passed
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    outputs:
      deploy-ready: ${{ steps.check.outputs.ready }}
      target-env: ${{ steps.env.outputs.environment }}
    
    steps:
    - name: âœ… Confirm tests passed
      id: check
      run: |
        echo "Tests passed successfully in previous workflow"
        echo "ready=true" >> $GITHUB_OUTPUT

    - name: ðŸŽ¯ Determine target environment
      id: env
      run: |
        if [ "${{ github.event.workflow_run.head_branch }}" == "master" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "ðŸ­ Target environment: Production"
        elif [ "${{ github.event.workflow_run.head_branch }}" == "develop" ]; then
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "ðŸ§ª Target environment: Development"
        else
          echo "environment=none" >> $GITHUB_OUTPUT
          echo "âŒ No deployment for branch: ${{ github.event.workflow_run.head_branch }}"
        fi

  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: check-tests
    if: needs.check-tests.outputs.deploy-ready == 'true' && needs.check-tests.outputs.target-env != 'none'
    
    outputs:
      build-success: ${{ steps.build-result.outputs.success }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build project
      run: npm run build

    - name: ðŸ§¹ Clean node_modules for production
      run: rm -rf node_modules

    - name: ðŸ“¦ Install production dependencies only
      run: npm ci --production --silent

    - name: ðŸ“¦ Create optimized deployment package
      run: |
        # Remove existing package
        rm -f lambda-deployment.zip
        
        # Create temporary directory for packaging
        TEMP_DIR="temp-lambda-package"
        rm -rf "$TEMP_DIR"
        mkdir -p "$TEMP_DIR"
        
        # Copy required files
        cp -r dist "$TEMP_DIR/"
        cp package.json "$TEMP_DIR/"
        cp index.mjs "$TEMP_DIR/"
        
        # Copy node_modules excluding unnecessary files
        mkdir -p "$TEMP_DIR/node_modules"
        
        # Use rsync to copy node_modules with exclusions
        rsync -a --exclude='*.md' \
                 --exclude='*.txt' \
                 --exclude='*.log' \
                 --exclude='*.map' \
                 --exclude='*.d.ts.map' \
                 --exclude='*.test.js' \
                 --exclude='*.spec.js' \
                 --exclude='*.test.ts' \
                 --exclude='*.spec.ts' \
                 --exclude='Gruntfile.js' \
                 --exclude='gulpfile.js' \
                 --exclude='Makefile' \
                 --exclude='*.mk' \
                 --exclude='*.gyp' \
                 --exclude='*.gypi' \
                 --exclude='.eslintrc*' \
                 --exclude='.jshintrc' \
                 --exclude='.jscsrc' \
                 --exclude='.babelrc*' \
                 --exclude='tsconfig.json' \
                 --exclude='tslint.json' \
                 --exclude='*.tgz' \
                 --exclude='*.tar.gz' \
                 --exclude='.git/' \
                 --exclude='test/' \
                 --exclude='tests/' \
                 --exclude='__tests__/' \
                 --exclude='spec/' \
                 --exclude='specs/' \
                 --exclude='example/' \
                 --exclude='examples/' \
                 --exclude='demo/' \
                 --exclude='demos/' \
                 --exclude='doc/' \
                 --exclude='docs/' \
                 --exclude='documentation/' \
                 --exclude='.nyc_output/' \
                 --exclude='coverage/' \
                 --exclude='.cache/' \
                 --exclude='cache/' \
                 --exclude='tmp/' \
                 --exclude='temp/' \
                 node_modules/ "$TEMP_DIR/node_modules/"
        
        # Create the zip package
        cd "$TEMP_DIR"
        zip -r ../lambda-deployment.zip .
        cd ..
        
        # Clean up temp directory
        rm -rf "$TEMP_DIR"

    - name: ðŸ“Š Validate package size
      run: |
        PACKAGE_SIZE=$(stat -c%s lambda-deployment.zip)
        PACKAGE_SIZE_MB=$((PACKAGE_SIZE / 1024 / 1024))
        MAX_SIZE_MB=50
        
        ls -lh lambda-deployment.zip
        echo "ðŸ“Š Package size: ${PACKAGE_SIZE_MB}MB"
        
        if [ $PACKAGE_SIZE_MB -gt $MAX_SIZE_MB ]; then
          echo "âŒ Error: Package size (${PACKAGE_SIZE_MB}MB) exceeds AWS Lambda limit (${MAX_SIZE_MB}MB)"
          echo "ðŸ’¡ Consider removing more dependencies or using Lambda Layers"
          exit 1
        else
          echo "âœ… Package size is within AWS Lambda limits"
        fi

    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lambda-deployment-package-${{ github.run_number }}
        path: lambda-deployment.zip
        retention-days: 30

    - name: âœ… Set build result
      id: build-result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… Build completed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed"
          exit 1
        fi

  deploy-dev:
    name: ðŸ§ª Deploy to Development
    runs-on: ubuntu-latest
    needs: [check-tests, build]
    if: |
      needs.check-tests.outputs.target-env == 'development' && 
      needs.build.outputs.build-success == 'true'
    environment: Dev
    
    steps:
    - name: ðŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: lambda-deployment-package-${{ github.run_number }}

    - name: ðŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ðŸš€ Deploy to Lambda
      run: |
        echo "ðŸš€ Deploying to Development Lambda..."
        aws lambda update-function-code \
          --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
          --zip-file fileb://lambda-deployment.zip

    - name: âš™ï¸ Update function configuration
      run: |
        echo "âš™ï¸ Updating Development Lambda configuration..."
        aws lambda update-function-configuration \
          --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
          --environment Variables="{
            \"NODE_ENV\":\"development\",
            \"FINANCE_API_BASE_URL\":\"${{ secrets.FINANCE_API_BASE_URL_DEV }}\",
            \"FINANCE_API_KEY\":\"${{ secrets.FINANCE_API_KEY_DEV }}\",
            \"BIGQUERY_PROJECT_ID\":\"${{ secrets.BIGQUERY_PROJECT_ID }}\",
            \"BIGQUERY_PRIVATE_KEY\":\"${{ secrets.BIGQUERY_PRIVATE_KEY }}\",
            \"BIGQUERY_CLIENT_EMAIL\":\"${{ secrets.BIGQUERY_CLIENT_EMAIL }}\",
            \"X_API_KEY\":\"${{ secrets.X_API_KEY }}\"
          }"

    - name: âœ… Development deployment complete
      run: |
        echo "âœ… Development deployment completed successfully"
        echo "ðŸ”— Function: ${{ secrets.LAMBDA_FUNCTION_NAME }}"
        echo "ðŸŒ Region: ${{ secrets.AWS_REGION }}"

  deploy-prod:
    name: ðŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [check-tests, build]
    if: |
      needs.check-tests.outputs.target-env == 'production' && 
      needs.build.outputs.build-success == 'true'
    environment: Prod
    
    steps:
    - name: ðŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: lambda-deployment-package-${{ github.run_number }}

    - name: ðŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ðŸš€ Deploy to Lambda
      run: |
        echo "ðŸš€ Deploying to Production Lambda..."
        aws lambda update-function-code \
          --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
          --zip-file fileb://lambda-deployment.zip

    - name: âš™ï¸ Update function configuration
      run: |
        echo "âš™ï¸ Updating Production Lambda configuration..."
        aws lambda update-function-configuration \
          --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
          --environment Variables="{
            \"NODE_ENV\":\"production\",
            \"FINANCE_API_BASE_URL\":\"${{ secrets.FINANCE_API_BASE_URL_DEV }}\",
            \"FINANCE_API_KEY\":\"${{ secrets.FINANCE_API_KEY_DEV }}\",
            \"BIGQUERY_PROJECT_ID\":\"${{ secrets.BIGQUERY_PROJECT_ID }}\",
            \"BIGQUERY_PRIVATE_KEY\":\"${{ secrets.BIGQUERY_PRIVATE_KEY }}\",
            \"BIGQUERY_CLIENT_EMAIL\":\"${{ secrets.BIGQUERY_CLIENT_EMAIL }}\",
            \"X_API_KEY\":\"${{ secrets.X_API_KEY }}\"
          }"

    - name: ðŸ·ï¸ Create release tag
      run: |
        echo "ðŸ·ï¸ Creating release tag..."
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create and push tag
        TAG_NAME="v${{ github.run_number }}"
        git tag -a $TAG_NAME -m "Production release $TAG_NAME"
        git push origin $TAG_NAME

    - name: ðŸ“‹ Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: ðŸš€ Production Release v${{ github.run_number }}
        body: |
          ## ðŸš€ Production Deployment
          
          **Deployed to Production Lambda**: `${{ secrets.LAMBDA_FUNCTION_NAME }}`
          
          ### ðŸ“Š Build Information
          - **Commit**: ${{ github.event.workflow_run.head_sha }}
          - **Branch**: ${{ github.event.workflow_run.head_branch }}
          - **Workflow Run**: #${{ github.run_number }}
          - **Node.js**: ${{ env.NODE_VERSION }}
          
          ### ðŸ”„ Changes
          ${{ github.event.workflow_run.head_commit.message }}
          
          ---
          *Automated release from GitHub Actions* ðŸ¤–
        draft: false
        prerelease: false

    - name: âœ… Production deployment complete
      run: |
        echo "âœ… Production deployment completed successfully"
        echo "ðŸ”— Function: ${{ secrets.LAMBDA_FUNCTION_NAME }}"
        echo "ðŸŒ Region: ${{ secrets.AWS_REGION }}"
        echo "ðŸ·ï¸ Release: v${{ github.run_number }}"

  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [check-tests, build, deploy-dev, deploy-prod]
    if: always() && needs.check-tests.outputs.deploy-ready == 'true'
    
    steps:
    - name: ðŸ“Š Generate deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.check-tests.outputs.target-env }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ needs.build.outputs.build-success == 'true' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.check-tests.outputs.target-env }}" == "development" ]; then
          echo "- **Development Deploy**: ${{ needs.deploy-dev.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.check-tests.outputs.target-env }}" == "production" ]; then
          echo "- **Production Deploy**: ${{ needs.deploy-prod.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: v${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **Branch**: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY