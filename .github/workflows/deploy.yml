name: 🚀 Build & Deploy

on:
  workflow_run:
    workflows: ["🧪 Test & Quality Assurance"]
    types: [completed]
    branches: [ master, develop ]

env:
  NODE_VERSION: '22.x'

jobs:
  build:
    name: 🏗️ Build & Deploy Application
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/develop' && 'Dev' || github.ref == 'refs/heads/testing' && 'Test' || github.ref == 'refs/heads/master'  && 'Prod' }}

    outputs:
      build-success: ${{ steps.build-result.outputs.success }}
      package-size: ${{ steps.size-check.outputs.size }}

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 📦 Install dependencies
      run: npm ci

    - name: 🏗️ Build project
      run: npm run build

    - name: 🧹 Clean node_modules for production
      run: rm -rf node_modules

    - name: 📦 Install production dependencies only
      run: npm ci --production --silent

    - name: 📦 Create optimized deployment package
      run: |
        # Create temporary directory for packaging
        TEMP_DIR="temp-lambda-package"
        rm -rf "$TEMP_DIR"
        mkdir -p "$TEMP_DIR"
        
        # Copy required files
        cp -r dist "$TEMP_DIR/"
        cp package.json "$TEMP_DIR/"
        cp index.mjs "$TEMP_DIR/"
        
        # Copy node_modules excluding unnecessary files
        mkdir -p "$TEMP_DIR/node_modules"
        
        # Use rsync to copy node_modules with exclusions
        rsync -a --exclude='*.md' \
                 --exclude='*.txt' \
                 --exclude='*.log' \
                 --exclude='*.map' \
                 --exclude='*.d.ts.map' \
                 --exclude='*.test.js' \
                 --exclude='*.spec.js' \
                 --exclude='*.test.ts' \
                 --exclude='*.spec.ts' \
                 --exclude='Gruntfile.js' \
                 --exclude='gulpfile.js' \
                 --exclude='Makefile' \
                 --exclude='*.mk' \
                 --exclude='*.gyp' \
                 --exclude='*.gypi' \
                 --exclude='.eslintrc*' \
                 --exclude='.jshintrc' \
                 --exclude='.jscsrc' \
                 --exclude='.babelrc*' \
                 --exclude='tsconfig.json' \
                 --exclude='tslint.json' \
                 --exclude='*.tgz' \
                 --exclude='*.tar.gz' \
                 --exclude='.git/' \
                 --exclude='test/' \
                 --exclude='tests/' \
                 --exclude='__tests__/' \
                 --exclude='spec/' \
                 --exclude='specs/' \
                 --exclude='example/' \
                 --exclude='examples/' \
                 --exclude='demo/' \
                 --exclude='demos/' \
                 --exclude='doc/' \
                 --exclude='docs/' \
                 --exclude='documentation/' \
                 --exclude='.nyc_output/' \
                 --exclude='coverage/' \
                 --exclude='.cache/' \
                 --exclude='cache/' \
                 --exclude='tmp/' \
                 --exclude='temp/' \
                 node_modules/ "$TEMP_DIR/node_modules/"
        
        # Create the zip package
        cd "$TEMP_DIR"
        zip -r ../${{ github.sha }}.zip .
        cd ..
        
        # Clean up temp directory
        rm -rf "$TEMP_DIR"

    - name: 📊 Validate package size
      id: package-and-validate
      run: |
        zip -r "${{ github.sha }}.zip" .
        size_bytes=$(du -sb "${{ github.sha }}.zip" | cut -f1)
        echo "ZIP size: $(( size_bytes/1024 )) KB"
        if [ "$size_bytes" -gt 52428800 ]; then
          echo "Error: ZIP > 50MB"
          exit 1
        fi

    - name: 🔐 Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lambda-package-${{ github.event.workflow_run.run_number }}
        path: ${{ github.sha }}.zip
        retention-days: 10
        if-no-files-found: error
        compression-level: 6

    - name: 🚀 Deploy to Lambda
      id: deploy-version
      if: success()
      run: |
        echo "🚀 Deploying to Lambda..."
        
        aws lambda update-function-code \
          --function-name "${{ secrets.LAMBDA_FUNCTION_NAME }}" \
          --zip-file fileb://${{ github.sha }}.zip
        
        # Store function name for later steps
        echo "function-name=${{ secrets.LAMBDA_FUNCTION_NAME }}" >> $GITHUB_OUTPUT

    - name: ⚙️ Update function configuration
      run: |
        echo "⚙️ Updating Lambda configuration..."
        aws lambda update-function-configuration \
          --function-name "${{ secrets.LAMBDA_FUNCTION_NAME }}" \
          --environment Variables="{
            \"FINANCE_API_BASE_URL\":\"${{ secrets.FINANCE_API_BASE_URL_DEV }}\",
            \"FINANCE_API_KEY\":\"${{ secrets.FINANCE_API_KEY_DEV }}\",
            \"BIGQUERY_PROJECT_ID\":\"${{ secrets.BIGQUERY_PROJECT_ID }}\",
            \"BIGQUERY_PRIVATE_KEY\":\"${{ secrets.BIGQUERY_PRIVATE_KEY }}\",
            \"BIGQUERY_CLIENT_EMAIL\":\"${{ secrets.BIGQUERY_CLIENT_EMAIL }}\",
            \"X_API_KEY\":\"${{ secrets.X_API_KEY }}\"
          }"

    - name: 🧹 Remove Temporary Deployment Package
      run: rm -f ${{ github.sha }}.zip

    - name: ✅ Set build result
      id: build-result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "✅ Lambda deployment completed successfully"
          echo "✅ Build completed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "❌ Lambda deployment failed"
          echo "❌ Build failed"
          exit 1
        fi

  deployment-summary:
    name: 📊 Deployment Summary
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    environment: ${{ github.ref == 'refs/heads/develop' && 'Dev' || github.ref == 'refs/heads/testing' && 'Test' || github.ref == 'refs/heads/master'  && 'Prod' }}
    
    steps:
    - name: 📊 Generate deployment summary
      run: |
        echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.ref == 'refs/heads/develop' && 'Dev' && '🧪 Development' || github.ref == 'refs/heads/master'  && 'Prod' && '🏭 Production' || github.ref == 'refs/heads/testing' && '🧪 Testing' || '❌ Other' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: ${{ needs.build.outputs.build-success == 'true' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy Status**: ${{ needs.build.outputs.build-success == 'true' && '✅ Deployed' || '❌ Not Deployed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Source Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.event.workflow_run.head_branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Run**: \`${{ github.event.workflow_run.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ⏰ Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered At**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Node Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY