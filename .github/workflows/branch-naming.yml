name: Branch Naming Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, develop]

jobs:
  validate-branch-name:
    name: üåø Validate Branch Naming Convention
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch name
        run: |
          branch_name="${{ github.head_ref }}"
          echo "üîç Validating branch name: $branch_name"
          
          # Define the regex pattern for valid branch names
          # Format: <type>/FB-<number>_<description>
          pattern="^(feat|fix|hotfix|refactor|docs|test|chore)\/FB-[0-9]+_[a-z0-9-]+$"
          
          if [[ $branch_name =~ $pattern ]]; then
            echo "‚úÖ Branch name follows the convention: $branch_name"
            echo "üìã Pattern: <type>/FB-<number>_<description>"
            echo "üéØ Examples:"
            echo "   - feat/FB-123_nueva-funcionalidad"
            echo "   - fix/FB-456_correccion-bug"
            echo "   - hotfix/FB-789_fallo-critico"
          else
            echo "‚ùå Branch name does not follow the convention: $branch_name"
            echo ""
            echo "üìã Required format: <type>/FB-<number>_<description>"
            echo ""
            echo "üîß Valid types: feat, fix, hotfix, refactor, docs, test, chore"
            echo "üéØ Examples:"
            echo "   ‚úÖ feat/FB-123_integracion-bigquery"
            echo "   ‚úÖ fix/FB-456_error-conexion-mongodb"
            echo "   ‚úÖ hotfix/FB-789_fallo-critico-produccion"
            echo "   ‚úÖ refactor/FB-234_optimizacion-queries"
            echo "   ‚úÖ docs/FB-567_actualizacion-readme"
            echo "   ‚úÖ test/FB-890_cobertura-servicios"
            echo "   ‚úÖ chore/FB-101_actualizacion-dependencias"
            echo ""
            echo "‚ùå Invalid examples:"
            echo "   ‚ùå feature/FB-123-nueva-funcionalidad (wrong type)"
            echo "   ‚ùå feat/JIRA-123_nueva-funcionalidad (wrong prefix)"
            echo "   ‚ùå feat/FB-123-nueva-funcionalidad (missing underscore)"
            echo "   ‚ùå feat/FB-123_Nueva_Funcionalidad (uppercase/underscores)"
            echo "   ‚ùå feat/FB-123_nueva funcionalidad (spaces)"
            echo ""
            echo "üìñ For more details, see: CONTRIBUTING.md#convenciones-de-nomenclatura-de-ramas"
            exit 1
          fi
      
      - name: Add PR comment with validation result
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const comment = `## ‚ùå Branch Naming Convention Violation
            
            **Branch:** \`${branchName}\`
            
            Your branch name does not follow our naming convention. Please rename your branch to follow this format:
            
            \`\`\`
            <type>/FB-<number>_<description>
            \`\`\`
            
            ### üîß Valid Types
            - \`feat/\` - New features
            - \`fix/\` - Bug fixes  
            - \`hotfix/\` - Urgent production fixes
            - \`refactor/\` - Code refactoring
            - \`docs/\` - Documentation changes
            - \`test/\` - Adding or modifying tests
            - \`chore/\` - Maintenance tasks
            
            ### ‚úÖ Examples
            - \`feat/FB-123_integracion-bigquery\`
            - \`fix/FB-456_error-conexion-mongodb\`
            - \`hotfix/FB-789_fallo-critico-produccion\`
            
            ### üìñ More Information
            See our [Contributing Guide](./CONTRIBUTING.md#convenciones-de-nomenclatura-de-ramas) for detailed naming conventions.
            
            ---
            
            **How to rename your branch:**
            \`\`\`bash
            git branch -m ${branchName} <new-branch-name>
            git push origin -u <new-branch-name>
            git push origin --delete ${branchName}
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });